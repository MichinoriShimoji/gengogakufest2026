<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bigram Surprisal 計算法と実例</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Source+Sans+3:ital,wght@0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;600&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--serif:'Cormorant Garamond','Noto Sans JP',serif;--sans:'Source Sans 3','Noto Sans JP',sans-serif;--mono:'JetBrains Mono',monospace;--red:#b83028;--red-bg:#fdf5f4;--blu:#2858a0;--blu-bg:#f4f7fd;--pur:#6838a0;--gold:#a07818;--gold-bg:#fdfaf2;--fg:#2a2a28;--dim:#777;--muted:#aaa;--bg:#fefdfb;--rule:#e0ddd8;--rule2:#eceae5;--green:#2e7d32;--green-bg:#f2f9f2}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:var(--sans);background:var(--bg);color:var(--fg);line-height:1.75;font-size:16px}
  .page{max-width:760px;margin:0 auto;padding:60px 24px 80px}
  .title-block{margin-bottom:48px;border-bottom:2px solid var(--fg);padding-bottom:32px}
  .title-block h1{font-family:var(--serif);font-size:32px;font-weight:700;line-height:1.3;margin-bottom:8px}
  .title-block .subtitle{font-family:var(--serif);font-size:18px;font-style:italic;color:var(--dim);margin-bottom:12px}
  h2{font-family:var(--serif);font-size:24px;font-weight:700;margin:48px 0 16px;padding-bottom:6px;border-bottom:1px solid var(--rule)}
  h3{font-family:var(--sans);font-size:17px;font-weight:700;margin:28px 0 10px}
  p{margin-bottom:14px}
  code{font-family:var(--mono);font-size:.88em;background:#f3f1ec;padding:1px 5px;border-radius:3px}
  .table-wrap{overflow-x:auto;margin:16px 0 8px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);text-align:left;padding:8px 10px;border-bottom:2px solid var(--fg)}
  th.r{text-align:right}
  td{padding:7px 10px;border-bottom:1px solid var(--rule2);font-family:var(--mono);font-size:13px}
  td.r{text-align:right}td.l{font-family:var(--sans);font-size:14px}
  tr:hover{background:rgba(0,0,0,.015)}
  tr.hl{background:rgba(184,48,40,.04)}
  tr.bnd td{border-bottom:2px solid var(--gold)}
  .caption{font-size:13px;color:var(--dim);font-style:italic;margin:4px 0 20px;line-height:1.5}
  .formula{text-align:center;font-family:var(--mono);font-size:15px;padding:14px 0;margin:12px 0;background:#f8f7f4;border-radius:6px;line-height:2}
  .callout{border-left:4px solid;padding:14px 18px;border-radius:0 6px 6px 0;margin:16px 0;font-size:15px}
  .step-badge{display:inline-block;font-family:var(--mono);font-size:12px;font-weight:600;background:var(--fg);color:var(--bg);padding:2px 10px;border-radius:3px;margin-right:8px;vertical-align:middle}
  .sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin:16px 0 20px}
  .sg-item{background:#f8f7f4;border-radius:6px;padding:10px 14px;text-align:center}
  .sg-item .v{font-family:var(--mono);font-size:20px;font-weight:600}
  .sg-item .k{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.3px}
  .compare{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
  .compare .box{padding:14px 16px;border-radius:8px;font-size:14px}
  .compare .box .val{font-family:var(--mono);font-size:22px;font-weight:600;margin-bottom:2px}
  .compare .yes{background:var(--green-bg);border-left:4px solid var(--green)}
  .compare .no{background:#fdf5f4;border-left:4px solid #c44}
  @media print{body{font-size:11pt}.page{max-width:100%;padding:0}h2{break-after:avoid}}
  @media(max-width:600px){.compare{grid-template-columns:1fr}.title-block h1{font-size:26px}}
</style>
</head>
<body>
<div class="page">

<div class="title-block">
  <h1>Bigram Surprisal 計算法と実例</h1>
  <div class="subtitle">宮古語コーパスでの実装例</div>
</div>

<!-- ═══ 1. What is surprisal ═══ -->
<h2>1. サプライザルとは</h2>
<p>サプライザル（surprisal）は、ある語が文脈上どれだけ「予想外」かをビット単位で測る情報理論的指標である。値が高いほど予測困難（情報量が大きい）、低いほど予測容易（冗長）である。</p>
<div class="formula">S(w) = −log₂ P(w | context)</div>
<p>本研究ではバイグラム（直前の1語）を文脈とする。より高次の n-gram やニューラルモデルも可能だが、小規模コーパスではバイグラムが最も安定する。</p>

<!-- ═══ 2. Pipeline ═══ -->
<h2>2. 計算パイプライン</h2>

<h3><span class="step-badge">Step 1</span> 語レベルへの折り畳み</h3>
<p>形態素レベルのアノテーションを <code>word_unit_id</code> でグループ化し、先頭形態素を語トークンの代表とする。節境界（boundary）は語グループ内のどの形態素にあっても語トークンに伝播する。</p>
<div class="callout" style="border-color:var(--gold);background:var(--gold-bg);">
  <strong>例:</strong> <code>misin-as-i-i</code>（4形態素、word_unit_id=1）→ 語トークン <code>misin</code>。末尾形態素 <code>i</code> の節境界 [EAC] が語トークンに伝播される。
</div>
<p>なぜ形態素レベルでなく語レベルか？ 語内部の形態素（接辞など）は S̄ = 2.83 と非常に予測容易で、「次に何の話が来るか」というサプライザルの趣旨とは質が違う。語レベル（S̄ = 4.95）のほうが語彙的予測を適切に反映する。</p>

<h3><span class="step-badge">Step 2</span> バイグラムモデル構築</h3>
<p>Add-α smoothing（α = 0.01）付き。未知のバイグラムにも微小な確率を付与する:</p>
<div class="formula">P(w | c) = (count(c, w) + 0.01) / (count(c) + 0.01 × 883)</div>
<p>本コーパスでは V = 883 タイプ、T = 4,681 トークン。</p>

<h3><span class="step-badge">Step 3</span> 節境界リセット</h3>
<p>節境界（EOS / EAC / EQC / Q）を持つ語の後では、次の語の文脈を &lt;BOS&gt;（文頭）にリセットする。これにより、節をまたいだ不自然なバイグラムを避ける。</p>
<div class="compare">
  <div class="box yes">
    <div class="val" style="color:var(--green)">S = 5.04</div>
    <strong>リセットあり ✓</strong><br>
    <code>...du</code>[EAC] → <code>mmja</code><br>
    文脈: <code>&lt;BOS&gt;</code> → <code>mmja</code>
  </div>
  <div class="box no">
    <div class="val" style="color:#c44">S = 3.96</div>
    <strong>リセットなし ✗</strong><br>
    <code>...du</code>[EAC] → <code>mmja</code><br>
    文脈: <code>du</code> → <code>mmja</code>
  </div>
</div>
<p>リセットにより 1.08 bits の差が生じる。リセットしないと、節境界後の語のサプライザルが不当に低くなる。</p>

<h3><span class="step-badge">Step 4</span> サプライザル計算</h3>
<p>全 4,681 位置のサプライザルを計算。コーパス全体の統計:</p>
<div class="sg">
  <div class="sg-item"><div class="v">4.95</div><div class="k">平均 S̄ (bits)</div></div>
  <div class="sg-item"><div class="v">2.30</div><div class="k">標準偏差 SD</div></div>
  <div class="sg-item"><div class="v">4,681</div><div class="k">語トークン</div></div>
  <div class="sg-item"><div class="v">883</div><div class="k">語彙 V</div></div>
</div>

<!-- ═══ 3. Worked example ═══ -->
<h2>3. 計算実例: 文 0 の先頭 10 語</h2>
<p>文 0 の先頭部分を用いて、実際の計算過程を示す。</p>
<div class="table-wrap"><table>
  <thead><tr><th>i</th><th>語 (w<sub>i</sub>)</th><th>POS</th><th>文脈 (w<sub>i−1</sub>)</th><th class="r">S (bits)</th><th>境界</th><th>次の文脈</th></tr></thead>
  <tbody>
    <tr class="hl"><td>0</td><td><strong style="color:var(--red)">mmja</strong></td><td>INTJ</td><td>&lt;BOS&gt;</td><td class="r"><strong>5.04</strong></td><td></td><td>&lt;BOS&gt; → mmja</td></tr>
    <tr class="bnd"><td>1</td><td>misin</td><td>N</td><td>mmja</td><td class="r"><strong>7.19</strong></td><td style="color:var(--gold)">EAC</td><td>mmja → misin → <em>reset</em></td></tr>
    <tr><td>2</td><td>ka</td><td>INTJ</td><td>&lt;BOS&gt;</td><td class="r"><strong>8.91</strong></td><td></td><td>&lt;BOS&gt; → ka</td></tr>
    <tr class="bnd"><td>3</td><td>tti</td><td>CJP</td><td>ka</td><td class="r"><strong>2.07</strong></td><td style="color:var(--gold)">EQC</td><td>ka → tti → <em>reset</em></td></tr>
    <tr><td>4</td><td>u</td><td>AUX</td><td>&lt;BOS&gt;</td><td class="r"><strong>9.49</strong></td><td></td><td>&lt;BOS&gt; → u</td></tr>
    <tr class="bnd"><td>5</td><td>du</td><td>ISP</td><td>u</td><td class="r"><strong>4.48</strong></td><td style="color:var(--gold)">EAC</td><td>u → du → <em>reset</em></td></tr>
    <tr class="hl"><td>6</td><td><strong style="color:var(--red)">mmja</strong></td><td>INTJ</td><td>&lt;BOS&gt;</td><td class="r"><strong>5.04</strong></td><td></td><td>&lt;BOS&gt; → mmja</td></tr>
    <tr><td>7</td><td>kuusjuu</td><td>N</td><td>mmja</td><td class="r"><strong>7.19</strong></td><td></td><td>mmja → kuusjuu</td></tr>
    <tr><td>8</td><td>nu</td><td>CP</td><td>kuusjuu</td><td class="r"><strong>2.43</strong></td><td></td><td>kuusjuu → nu</td></tr>
    <tr><td>9</td><td>sugu</td><td>INTJ</td><td>nu</td><td class="r"><strong>7.58</strong></td><td></td><td>nu → sugu</td></tr>
  </tbody>
</table></div>
<p class="caption">表 1: 文 0 の先頭 10 語のサプライザル計算過程。境界がある語の後で文脈が &lt;BOS&gt; にリセットされる。mmja の行をハイライト。</p>
<p>注目点: w₀ = <strong style="color:var(--red)">mmja</strong> の直後の w₁ = <code>misin</code> は S = 7.19 bits と非常に高い。これは mmja の後に多様な語が来るため、どの語も予測しにくいことを反映している。一方、w₃ = <code>tti</code> は S = 2.07 と低く、<code>ka</code> の後に <code>tti</code> が来るのは予測容易である。</p>

<!-- ═══ 4. Bigram details ═══ -->
<h2>4. バイグラムの具体例: mmja の後続語</h2>
<p>mmja が文脈として現れた回数は 139 回。上位 8 バイグラム:</p>
<div class="table-wrap"><table>
  <thead><tr><th>mmja → X</th><th class="r">count</th><th class="r">P(X|mmja)</th><th class="r">S (bits)</th><th>傾向</th></tr></thead>
  <tbody>
    <tr><td>mmja → unu</td><td class="r">8</td><td class="r">0.0542</td><td class="r">4.21</td><td class="l">低↓</td></tr>
    <tr><td>mmja → sjeisjunzidai</td><td class="r">4</td><td class="r">0.0271</td><td class="r">5.20</td><td class="l">≈平均</td></tr>
    <tr><td>mmja → tur</td><td class="r">4</td><td class="r">0.0271</td><td class="r">5.20</td><td class="l">≈平均</td></tr>
    <tr><td>mmja → nau</td><td class="r">4</td><td class="r">0.0271</td><td class="r">5.20</td><td class="l">≈平均</td></tr>
    <tr><td>mmja → uri</td><td class="r">4</td><td class="r">0.0271</td><td class="r">5.20</td><td class="l">≈平均</td></tr>
    <tr><td>mmja → mm</td><td class="r">3</td><td class="r">0.0204</td><td class="r">5.62</td><td class="l">≈平均</td></tr>
    <tr><td>mmja → par</td><td class="r">3</td><td class="r">0.0204</td><td class="r">5.62</td><td class="l">≈平均</td></tr>
    <tr><td>mmja → ui</td><td class="r">3</td><td class="r">0.0204</td><td class="r">5.62</td><td class="l">≈平均</td></tr>
  </tbody>
</table></div>
<p class="caption">表 2: mmja 後続バイグラム上位 8。最頻の unu でも count = 8 と少なく、後続語は非常に多様。</p>
<div class="callout" style="border-color:var(--red);background:var(--red-bg);">
  <strong>重要な洞察:</strong> mmja の後には 112 種の異なる語が現れる（V = 883 の約 13%）。特定の語への偏りが小さいため、どの後続語も予測困難（高サプライザル）になる。これが mmja の post S̄ = 6.79 の原因であり、「これから難しい内容が来る」というアラート機能と整合的である。
</div>

<!-- ═══ 5. Offset analysis ═══ -->
<h2>5. オフセット分析</h2>
<p>ターゲット語の前後 5 位置のサプライザルを集計することで、「周辺の情報密度プロファイル」が見える。オフセット 0 が自身、− が前、+ が後。</p>
<div class="table-wrap"><table>
  <thead><tr><th>offset</th><th class="r">S̄</th><th class="r">n</th><th class="r">d</th></tr></thead>
  <tbody>
    <tr><td>−5</td><td class="r">4.60</td><td class="r">107</td><td class="r">−0.15</td></tr>
    <tr><td>−4</td><td class="r">5.46</td><td class="r">121</td><td class="r">+0.22</td></tr>
    <tr><td>−3</td><td class="r">5.17</td><td class="r">131</td><td class="r">+0.09</td></tr>
    <tr><td>−2</td><td class="r">5.11</td><td class="r">143</td><td class="r">+0.07</td></tr>
    <tr class="hl"><td><strong>pre (−1)</strong></td><td class="r"><strong>4.66</strong></td><td class="r"><strong>153</strong></td><td class="r"><strong>−0.13</strong></td></tr>
    <tr class="hl"><td><strong>self (0)</strong></td><td class="r"><strong>4.00</strong></td><td class="r"><strong>168</strong></td><td class="r"><strong>−0.41</strong></td></tr>
    <tr class="hl"><td><strong style="color:var(--red)">post (+1)</strong></td><td class="r"><strong style="color:var(--red)">6.79</strong></td><td class="r"><strong>164</strong></td><td class="r"><strong style="color:var(--red)">+0.80</strong></td></tr>
    <tr><td>+2</td><td class="r">3.77</td><td class="r">155</td><td class="r">−0.52</td></tr>
    <tr><td>+3</td><td class="r">5.15</td><td class="r">149</td><td class="r">+0.09</td></tr>
    <tr><td>+4</td><td class="r">4.76</td><td class="r">137</td><td class="r">−0.08</td></tr>
    <tr><td>+5</td><td class="r">5.08</td><td class="r">126</td><td class="r">+0.05</td></tr>
  </tbody>
</table></div>
<p class="caption">表 3: mmja のオフセット別サプライザル。post (+1) で急激に上昇し、+2 で急降下する「スパイク」が特徴的。</p>
<p>mmja のプロファイルは明確な「谷→山」型を示す: self (4.00) で最低、post (6.79) で最高。これは mmja 自体が予測容易でありつつ、その直後に予測困難な語が来ることを意味する。</p>

<!-- ═══ 6. Statistical testing ═══ -->
<h2>6. 統計検定</h2>
<p>サプライザル値の分布は正規ではないため、ノンパラメトリック検定（Wilcoxon signed-rank test）を使用する。帰無仮説は「ターゲット語の post サプライザル = コーパス平均」。多重比較補正は Bonferroni（k = 3、ターゲット語 3 種）。効果量は Cohen's d = (post S̄ − corpus S̄) / corpus SD。</p>
<div class="table-wrap"><table>
  <thead><tr><th>形式</th><th class="r">post S̄</th><th class="r">d</th><th class="r">p (raw)</th><th class="r">p (Bonf)</th></tr></thead>
  <tbody>
    <tr><td class="l"><strong style="color:var(--red)">mmja</strong></td><td class="r">6.79</td><td class="r" style="font-weight:600">+0.80</td><td class="r">&lt;.0001</td><td class="r">&lt;.0001</td></tr>
    <tr><td class="l"><strong style="color:var(--blu)">unu</strong></td><td class="r">5.63</td><td class="r">+0.29</td><td class="r">&lt;.0001</td><td class="r">&lt;.0001</td></tr>
    <tr><td class="l"><strong style="color:var(--pur)">naugara</strong></td><td class="r">4.61</td><td class="r">−0.15</td><td class="r">&lt;.0001</td><td class="r">&lt;.0001</td></tr>
  </tbody>
</table></div>
<p class="caption">表 4: 統計検定結果。三者とも p &lt; .0001 だが、効果の方向と大きさが異なる。</p>

<!-- ═══ 7. Implementation ═══ -->
<h2>7. 実装</h2>
<p>本分析の Python 実装は <code>surprisal_calc.py</code> として提供されている。スタンドアロンの HTML 版（<code>surprisal_calculator.html</code>）もあり、ブラウザ上で JSON をアップロードして計算できる。</p>
<h3>使い方</h3>
<div style="background:#1a1a1e;color:#e0ddd8;padding:14px 18px;border-radius:6px;font-family:var(--mono);font-size:13px;line-height:2;margin:12px 0;">
  <span style="color:#6bc26b">$</span> python surprisal_calc.py final.json<br>
  <span style="color:#6bc26b">$</span> python surprisal_calc.py final.json --alpha 0.05 --csv out.csv<br>
  <span style="color:#6bc26b">$</span> python surprisal_calc.py final.json --targets mmja unu --offsets -3 4
</div>
<p>入力 JSON の必須フィールド: <code>morphs</code>, <code>pos</code>, <code>gloss</code>, <code>boundary</code>, <code>sentence_id</code>, <code>word_unit_id</code>, <code>word_pos</code>。</p>

</div>
</body>
</html>
